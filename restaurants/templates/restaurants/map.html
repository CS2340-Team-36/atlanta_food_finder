<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Map</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-gray-100 text-gray-900">
    <h1 class="text-3xl font-bold text-center text-blue-600 mt-6 mb-4">Restaurant Map</h1>

    <!-- Filter Bar -->
    <div id="filter-bar" class="bg-blue-500 text-white p-4 flex justify-around items-center shadow-md">
        <div class="flex items-center">
            <label for="radius" class="font-semibold mr-2">Radius:</label>
            <select id="radius" class="p-2 rounded bg-white text-gray-800">
                <option value="8047">5 miles</option>
                <option value="16094">10 miles</option>
                <option value="32187">20 miles</option>
            </select>
        </div>

        <div class="flex items-center">
            <label for="cuisine" class="font-semibold mr-2">Cuisine:</label>
            <select id="cuisine" class="p-2 rounded bg-white text-gray-800">
                <option value="">All</option>
                <option value="mexican">Mexican</option>
                <option value="indian">Indian</option>
                <option value="chinese">Chinese</option>
                <option value="italian">Italian</option>
                <option value="american">American</option>
                <option value="thai">Thai</option>
                <option value="japanese">Japanese</option>
            </select>
        </div>

        <div class="flex items-center">
            <label for="rating" class="font-semibold mr-2">Minimum Rating:</label>
            <select id="rating" class="p-2 rounded bg-white text-gray-800">
                <option value="0">All</option>
                <option value="3.5">3.5+</option>
                <option value="4">4.0+</option>
                <option value="4.5">4.5+</option>
            </select>
        </div>

        <button onclick="applyFilters()" class="bg-blue-700 hover:bg-blue-800 text-white font-bold py-2 px-4 rounded shadow-lg transition duration-300">
            Apply Filters
        </button>
    </div>

    <div id="info" class="p-4"></div>
    <div id="map" class="h-screen w-2/3 float-left border-r-2 border-gray-300"></div>
    <div id="restaurant-list" class="h-screen w-1/3 float-right overflow-y-auto p-4 bg-white shadow-inner border-l-2 border-gray-300"></div>

    <script>
        let map;
        let infoWindow;
        let markers = [];  // Array to hold all markers

        function initMap() {
            // Initialize the map centered on Atlanta
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 33.7490, lng: -84.3880 }, // Centered on Atlanta
                zoom: 12,
            });

            // Initialize the info window to display restaurant details
            infoWindow = new google.maps.InfoWindow();

            // Initially, search for all nearby places when the map is idle
            map.addListener('idle', () => {
                searchNearbyPlaces(map.getCenter());
            });
        }

        function searchNearbyPlaces(location) {
            const radius = document.getElementById('radius').value || '8047'; // Default to 5 miles
            const cuisine = document.getElementById('cuisine').value;
            const minRating = document.getElementById('rating').value || '0';

            const request = {
                location: location,
                radius: radius,
                types: ['restaurant', 'cafe', 'diner', 'bakery', 'brewery', 'bar'], // Fixed case issues
            };

            const service = new google.maps.places.PlacesService(map);

            // Clear existing markers before adding new ones
            clearMarkers();

            service.nearbySearch(request, (results, status, pagination) => {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    const filteredResults = results.filter(place => {
                        // Filter based on rating
                        if (place.rating && place.rating < minRating) {
                            return false;
                        }
                        // Filter based on cuisine (if selected)
                        if (cuisine && !isCuisineMatch(place, cuisine)) {
                            return false;
                        }
                        return true;
                    });

                    // Log filteredResults to see if your filtering works
                    console.log(filteredResults);

                    // Create new markers for filtered results
                    filteredResults.forEach(place => {
                        createMarker(place);
                    });

                    // Fetch more results if available, apply filter to pagination as well
                    if (pagination && pagination.hasNextPage) {
                        setTimeout(() => {
                            pagination.nextPage();
                        }, 2000);
                    }
                }
            });
        }

        function isCuisineMatch(place, cuisine) {
            const cuisineMap = {
                mexican: ['mexican', 'taco'],
                indian: ['indian', 'naan'],
                chinese: ['noodle', 'chinese'],
                italian: ['italian', 'pizza'],
                american: ['burger', 'bbq', 'steak', 'diner', 'fast_food'],
                thai: ['thai'],
                japanese: ['japanese', 'sushi'],
            };

            const restaurantTypes = place.types || [];
            const restaurantName = place.name ? place.name.toLowerCase() : '';

            // Check if the restaurant name contains any keyword that matches the selected cuisine
            if (cuisineMap[cuisine].some(keyword => restaurantName.includes(keyword))) {
                return true;
            }

            // Check if the place types match the selected cuisine
            return cuisineMap[cuisine].some(keyword =>
                restaurantTypes.some(type => type.includes(keyword))
            );
        }

        function applyFilters() {
            const radius = document.getElementById('radius').value;
            const cuisine = document.getElementById('cuisine').value;
            const rating = document.getElementById('rating').value;

            console.log(`Filters - Radius: ${radius}, Cuisine: ${cuisine}, Rating: ${rating}`);

            // Refresh the map with new filters
            searchNearbyPlaces(map.getCenter());
        }

        function createMarker(place) {
            const marker = new google.maps.Marker({
                map: map,
                position: place.geometry.location,
            });

            markers.push(marker);

            // Add the restaurant name to the restaurant list
            const restaurantListDiv = document.getElementById('restaurant-list');
            const listItem = document.createElement('div');
            listItem.style.cursor = 'pointer';
            listItem.classList.add('restaurant-item', 'bg-white', 'p-4', 'mb-4', 'rounded-lg', 'shadow-md', 'hover:bg-blue-50', 'transition', 'duration-200');
            listItem.innerHTML = `
                <h3 class="text-xl font-semibold text-blue-600">${place.name}</h3>
                <p class="text-gray-700 mb-2">Rating: <span class="text-yellow-500 font-bold">${place.rating || 'N/A'}</span></p>
                <div class="restaurant-details text-sm text-gray-600 mt-2 hidden">
                    <p>Address: ${place.vicinity || 'N/A'}</p>
                    <p>Price Level: ${place.price_level ? '$'.repeat(place.price_level) : 'N/A'}</p>
                </div>
            `;
            restaurantListDiv.appendChild(listItem);

            // Click event for list item to toggle restaurant details
            listItem.addEventListener('click', function () {
                const details = listItem.querySelector('.restaurant-details');
                details.style.display = details.style.display === 'none' ? 'block' : 'none';
                highlightItem(listItem);  // Highlight this item when clicked
            });

            // Add click listener to marker to show restaurant details in the scroll bar
            google.maps.event.addListener(marker, 'click', () => {
                const service = new google.maps.places.PlacesService(map);
                service.getDetails({ placeId: place.place_id }, (details, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK) {
                        // Update the scroll bar list to show details when the marker is clicked
                        const listItems = restaurantListDiv.querySelectorAll('.restaurant-item');
                        listItems.forEach(item => {
                            const heading = item.querySelector('h3');
                            if (heading.innerText === details.name) {
                                const detailsDiv = item.querySelector('.restaurant-details');
                                detailsDiv.style.display = 'block';
                                highlightItem(item);  // Highlight the clicked marker's corresponding restaurant
                            } else {
                                const detailsDiv = item.querySelector('.restaurant-details');
                                detailsDiv.style.display = 'none';  // Collapse other restaurant details
                            }
                        });

                        // Update the info section with restaurant details (if needed)
                        document.getElementById('info').innerHTML = `
                            <h2 class="text-2xl font-bold text-blue-600">${details.name}</h2>
                            <p class="text-gray-800">Cuisine: ${getCuisineType(details)}</p>
                            <p class="text-gray-600">${details.formatted_address}</p>
                            <p class="text-gray-800">Rating: ${details.rating}</p>
                            <p class="text-gray-600">${details.formatted_phone_number || 'Phone number not available'}</p>
                        `;
                    }
                });
            });
        }

        function highlightItem(item) {
            const allItems = document.querySelectorAll('.restaurant-item');
            allItems.forEach(el => el.classList.remove('highlight'));  // Remove highlight from all
            item.classList.add('highlight');  // Add highlight to the clicked one
        }

        function clearMarkers() {
            for (let i = 0; i < markers.length; i++) {
                markers[i].setMap(null);  // Remove marker from the map
            }
            markers = [];  // Clear the markers array

            // Also clear the restaurant list
            const restaurantListDiv = document.getElementById('restaurant-list');
            restaurantListDiv.innerHTML = '';  // Clear the list
        }

        function getCuisineType(details) {
            const cuisineMap = {
                mexican: ['mexican'],
                indian: ['indian'],
                chinese: ['chinese'],
                italian: ['italian', 'pizza'],
                american: ['burger', 'bbq', 'steak', 'diner', 'fast_food'],
                thai: ['thai'],
                japanese: ['japanese', 'sushi'],
            };

            const restaurantName = details.name ? details.name.toLowerCase() : '';
            const restaurantTypes = details.types || [];

            for (const [cuisine, keywords] of Object.entries(cuisineMap)) {
                if (keywords.some(keyword => restaurantName.includes(keyword))) {
                    return capitalize(cuisine);
                }
            }

            for (const [cuisine, keywords] of Object.entries(cuisineMap)) {
                if (restaurantTypes.some(type => keywords.some(keyword => type.includes(keyword)))) {
                    return capitalize(cuisine);
                }
            }

            return 'Cuisine not available';
        }

        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function highlightRestaurant(restaurantId) {
            // Remove highlight from all restaurant blocks
            const allBlocks = document.querySelectorAll('.restaurant-block');
            allBlocks.forEach(block => {
                block.classList.remove('highlight');
                block.querySelector('.restaurant-details').classList.remove('show');
            });

            // Highlight the clicked restaurant block
            const selectedBlock = document.getElementById(restaurantId);
            selectedBlock.classList.add('highlight');
            selectedBlock.querySelector('.restaurant-details').classList.add('show');
        }

        function onMarkerClick(restaurantId) {
            // Highlight the corresponding restaurant block in the sidebar
            highlightRestaurant(restaurantId);

            // Optionally, scroll the restaurant block into view
            const block = document.getElementById(restaurantId);
            block.scrollIntoView({ behavior: "smooth", block: "start" });
        }

    </script>

    <!-- Load the Google Maps JavaScript API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDe39jHRou9FyAwtXDmqtMG2WglTXs7IkA&libraries=places&callback=initMap" async defer></script>
</body>
</html>
