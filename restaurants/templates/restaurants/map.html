<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Map</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-900">
    <h1 class="text-3xl font-bold text-center text-blue-600 mt-6 mb-4">Restaurant Map</h1>

    <!-- Filter Bar -->
    <div id="filter-bar" class="bg-blue-500 text-white p-4 flex justify-around items-center shadow-md">
        <div class="flex items-center">
            <label for="radius" class="font-semibold mr-2">Radius:</label>
            <select id="radius" class="p-2 rounded bg-white text-gray-800">
                <option value="8047">5 miles</option>
                <option value="16094">10 miles</option>
                <option value="32187">20 miles</option>
            </select>
        </div>

        <div class="flex items-center">
            <label for="cuisine" class="font-semibold mr-2">Cuisine:</label>
            <select id="cuisine" class="p-2 rounded bg-white text-gray-800">
                <option value="">All</option>
                <option value="mexican">Mexican</option>
                <option value="indian">Indian</option>
                <option value="chinese">Chinese</option>
                <option value="italian">Italian</option>
                <option value="american">American</option>
                <option value="thai">Thai</option>
                <option value="japanese">Japanese</option>
            </select>
        </div>

        <div class="flex items-center">
            <label for="rating" class="font-semibold mr-2">Minimum Rating:</label>
            <select id="rating" class="p-2 rounded bg-white text-gray-800">
                <option value="0">All</option>
                <option value="3.5">3.5+</option>
                <option value="4">4.0+</option>
                <option value="4.5">4.5+</option>
            </select>
        </div>

        <button onclick="applyFilters()" class="bg-blue-700 hover:bg-blue-800 text-white font-bold py-2 px-4 rounded shadow-lg transition duration-300">
            Apply Filters
        </button>
    </div>

    <div id="info" class="p-4"></div>
    <div id="map" class="h-screen w-2/3 float-left border-r-2 border-gray-300"></div>
    <div id="restaurant-list" class="h-screen w-1/3 float-right overflow-y-auto p-4 bg-white shadow-inner border-l-2 border-gray-300"></div>

    <!-- Notification Message -->
    <div id="notification" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 text-white px-4 py-2 rounded shadow-lg opacity-0 transition-opacity duration-500">
        Added to favorites
    </div>

    <script>
        let map;
        let infoWindow;
        let markers = [];
        let placesById = {};

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 33.7490, lng: -84.3880 },
                zoom: 12,
            });

            infoWindow = new google.maps.InfoWindow();

            map.addListener('idle', () => {
                searchNearbyPlaces(map.getCenter());
            });
        }

        function searchNearbyPlaces(location) {
            const radius = document.getElementById('radius').value || '8047';
            const cuisine = document.getElementById('cuisine').value;
            const minRating = document.getElementById('rating').value || '0';

            const request = {
                location: location,
                radius: radius,
                types: ['restaurant', 'cafe', 'diner', 'bakery', 'brewery', 'bar'],
            };

            const service = new google.maps.places.PlacesService(map);

            clearMarkers();

            service.nearbySearch(request, (results, status, pagination) => {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    const filteredResults = results.filter(place => {
                        if (place.rating && place.rating < minRating) {
                            return false;
                        }
                        if (cuisine && !isCuisineMatch(place, cuisine)) {
                            return false;
                        }
                        return true;
                    });

                    filteredResults.forEach(place => {
                        placesById[place.place_id] = place;
                        createMarker(place);
                    });

                    if (pagination && pagination.hasNextPage) {
                        setTimeout(() => {
                            pagination.nextPage();
                        }, 2000);
                    }
                }
            });
        }

        function isCuisineMatch(place, cuisine) {
            const cuisineMap = {
                mexican: ['mexican', 'taco'],
                indian: ['indian', 'naan'],
                chinese: ['noodle', 'chinese'],
                italian: ['italian', 'pizza'],
                american: ['burger', 'bbq', 'steak', 'diner', 'fast_food'],
                thai: ['thai'],
                japanese: ['japanese', 'sushi'],
            };

            const restaurantTypes = place.types || [];
            const restaurantName = place.name ? place.name.toLowerCase() : '';

            if (cuisineMap[cuisine].some(keyword => restaurantName.includes(keyword))) {
                return true;
            }

            return cuisineMap[cuisine].some(keyword =>
                restaurantTypes.some(type => type.includes(keyword))
            );
        }

        function applyFilters() {
            const radius = document.getElementById('radius').value;
            const cuisine = document.getElementById('cuisine').value;
            const rating = document.getElementById('rating').value;

            console.log(`Filters - Radius: ${radius}, Cuisine: ${cuisine}, Rating: ${rating}`);

            searchNearbyPlaces(map.getCenter());
        }

        function createMarker(place) {
            const marker = new google.maps.Marker({
                map: map,
                position: place.geometry.location,
            });

            markers.push(marker);

            const restaurantListDiv = document.getElementById('restaurant-list');
            const listItem = document.createElement('div');
            listItem.id = place.place_id;
            listItem.style.cursor = 'pointer';
            listItem.classList.add('restaurant-item', 'bg-white', 'p-4', 'mb-4', 'rounded-lg', 'shadow-md', 'hover:bg-blue-50', 'transition', 'duration-200');
            listItem.innerHTML = `
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-semibold text-blue-600">${place.name}</h3>
                    <span class="star text-gray-400 hover:text-yellow-500 transition-colors duration-300 text-2xl">&#9733;</span>
                </div>
                <p class="text-gray-700 mb-2">Rating: <span class="text-yellow-500 font-bold">${place.rating || 'N/A'}</span></p>
                <div class="restaurant-details text-sm text-gray-600 mt-2 hidden">
                    <p>Address: ${place.vicinity || 'N/A'}</p>
                    <p>Price Level: ${place.price_level ? '$'.repeat(place.price_level) : 'N/A'}</p>
                    <button class="mt-2 bg-blue-500 text-white py-1 px-3 rounded hover:bg-blue-600 transition duration-300 see-more-btn">See more</button>
                </div>
            `;

            restaurantListDiv.appendChild(listItem);

            listItem.addEventListener('click', function () {
                const details = listItem.querySelector('.restaurant-details');
                details.style.display = details.style.display === 'none' ? 'block' : 'none';
                highlightItem(listItem);
            });

            const star = listItem.querySelector('.star');
            star.addEventListener('click', function (event) {
                event.stopPropagation();
                const isFavorite = star.classList.toggle('text-yellow-500');
                if (isFavorite) {
                    showNotification('Added to favorites', 'bg-green-500');
                } else {
                    showNotification('Removed from favorites', 'bg-red-500');
                }
            });

            google.maps.event.addListener(marker, 'click', () => {
                onMarkerClick(place.place_id);
            });

            // Make sure the redirection path matches your Django setup
            listItem.querySelector('.see-more-btn').addEventListener('click', () => {
                const formattedName = place.name.replace(/\s+/g, '-').toLowerCase();
                // Adjust the URL path if needed
                window.location.href = `/restaurants/${formattedName}/`;
            });
        }

        function onMarkerClick(placeId) {
            const place = placesById[placeId];
            if (place) {
                highlightRestaurant(placeId);
            }
        }

        function highlightRestaurant(restaurantId) {
            const restaurantListDiv = document.getElementById('restaurant-list');
            const listItem = document.getElementById(restaurantId);

            if (listItem) {
                listItem.scrollIntoView({ behavior: 'smooth', block: 'start' });
                const details = listItem.querySelector('.restaurant-details');
                details.style.display = 'block';
                highlightItem(listItem);
            }
        }

        function highlightItem(item) {
            document.querySelectorAll('.restaurant-item').forEach(el => {
                el.classList.remove('bg-blue-100');
            });
            item.classList.add('bg-blue-100');
        }

        function clearMarkers() {
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            const restaurantListDiv = document.getElementById('restaurant-list');
            restaurantListDiv.innerHTML = '';
        }

        function showNotification(message, colorClass) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `fixed bottom-4 left-1/2 transform -translate-x-1/2 text-white px-4 py-2 rounded shadow-lg opacity-0 transition-opacity duration-500 ${colorClass}`;
            notification.classList.add('opacity-100');

            setTimeout(() => {
                notification.classList.remove('opacity-100');
            }, 2000);
        }
    </script>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDe39jHRou9FyAwtXDmqtMG2WglTXs7IkA&libraries=places&callback=initMap"></script>
</body>
</html>
